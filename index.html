
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>–ê—Ä—Ö–∏–≤ –ë—É—Ö–≥–∞–ª—Ç–µ—Ä–∏–∏</title>
  
  <!-- Telegram Web App SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  
  <!-- –ë–∏–±–ª–∏–æ—Ç–µ–∫–∏ —á–µ—Ä–µ–∑ CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: var(--tg-theme-secondary-bg-color, #f4f7f9);
      color: var(--tg-theme-text-color, #222);
      margin: 0; padding: 0; overflow: hidden;
    }
    #loading-screen {
      display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh;
      background: white; z-index: 9999; position: fixed; inset: 0;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .loader { width: 32px; height: 32px; border: 3px solid #f3f3f3; border-top: 3px solid #0088cc; border-radius: 50%; animation: spin 1s linear infinite; }
    .tg-button { background-color: var(--tg-theme-button-color, #0088cc); color: var(--tg-theme-button-text-color, #ffffff); }
    .chat-bubble-user { background-color: #effdde; border: 1px solid #d1e3b8; }
    .chat-bubble-system { background-color: #ffffff; border: 1px solid #e5e7eb; }
    ::-webkit-scrollbar { width: 4px; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
  </style>
<script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@^19.2.3",
    "react/": "https://esm.sh/react@^19.2.3/",
    "@google/genai": "https://esm.sh/@google/genai@^1.34.0"
  }
}
</script>
</head>
<body>
  <div id="root">
    <div id="loading-screen">
      <div class="loader"></div>
      <p style="margin-top: 16px; font-size: 11px; text-transform: uppercase; letter-spacing: 2px; color: #999; font-weight: 600;">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–∏—Å—Ç–µ–º—ã...</p>
    </div>
  </div>

  <script type="text/babel" data-presets="react,typescript">
    const { useState, useEffect, useRef } = React;

    // --- –ö–û–ù–°–¢–ê–ù–¢–´ ---
    const FOLDERS = [
      { id: 'invoices', name: '–°—á–µ—Ç–∞ –∏ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏', color: 'bg-blue-500', icon: 'üìÑ' },
      { id: 'waybills', name: '–ù–∞–∫–ª–∞–¥–Ω—ã–µ (–£–ü–î)', color: 'bg-emerald-500', icon: 'üöö' },
      { id: 'contracts', name: '–î–æ–≥–æ–≤–æ—Ä—ã', color: 'bg-amber-500', icon: 'üìù' },
      { id: 'taxes', name: '–ù–∞–ª–æ–≥–∏ –∏ –æ—Ç—á–µ—Ç—ã', color: 'bg-indigo-500', icon: 'üìä' },
      { id: 'misc', name: '–†–∞–∑–Ω–æ–µ', color: 'bg-slate-500', icon: 'üìÅ' },
    ];

    const COMMAND_MAP = {
      '/—Å—á–µ—Ç–∞': 'invoices', '/–∏–Ω–≤–æ–π—Å': 'invoices',
      '/–Ω–∞–∫–ª–∞–¥–Ω—ã–µ': 'waybills', '/—É–ø–¥': 'waybills',
      '/–¥–æ–≥–æ–≤–æ—Ä—ã': 'contracts', '/–∫–æ–Ω—Ç—Ä–∞–∫—Ç': 'contracts',
      '/–Ω–∞–ª–æ–≥–∏': 'taxes', '/–æ—Ç—á–µ—Ç': 'taxes', '/—Ä–∞–∑–Ω–æ–µ': 'misc'
    };

    // --- –ü–†–ò–õ–û–ñ–ï–ù–ò–ï ---
    const App = () => {
      const [view, setView] = useState('chat');
      const [currentFolder, setCurrentFolder] = useState(null);
      const [messages, setMessages] = useState([]);
      const [documents, setDocuments] = useState([]);
      const [inputText, setInputText] = useState('');
      const [isUploading, setIsUploading] = useState(false);
      const [showToast, setShowToast] = useState(null);

      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
      useEffect(() => {
        const tg = window.Telegram?.WebApp;
        if (tg) {
          tg.ready();
          tg.expand();
          tg.enableClosingConfirmation();
        }

        const savedDocs = localStorage.getItem('kin_archive_docs');
        if (savedDocs) {
          try {
            setDocuments(JSON.parse(savedDocs));
          } catch (e) {
            console.error(e);
          }
        }

        setMessages([{
          id: 'welcome',
          sender: 'system',
          text: 'üìÇ –ê—Ä—Ö–∏–≤ –ë—É—Ö–≥–∞–ª—Ç–µ—Ä–∏–∏ –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ.\n\n–ü—Ä–∏—à–ª–∏—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç, –∏ —è –æ–ø—Ä–µ–¥–µ–ª—é –µ–≥–æ –≤ –Ω—É–∂–Ω—É—é –ø–∞–ø–∫—É. –í—ã —Ç–∞–∫–∂–µ –º–æ–∂–µ—Ç–µ —É–∫–∞–∑–∞—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∫–æ–º–∞–Ω–¥–æ–π (–Ω–∞–ø—Ä–∏–º–µ—Ä: /—Å—á–µ—Ç–∞).',
          timestamp: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
        }]);

        // –£–±–∏—Ä–∞–µ–º —ç–∫—Ä–∞–Ω –∑–∞–≥—Ä—É–∑–∫–∏
        const loader = document.getElementById('loading-screen');
        if (loader) loader.style.display = 'none';
      }, []);

      // –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
      useEffect(() => {
        localStorage.setItem('kin_archive_docs', JSON.stringify(documents));
      }, [documents]);

      const handleSend = async (text, file) => {
        if (!text.trim() && !file) return;

        if (file) {
          setIsUploading(true);
          
          // –õ–æ–≥–∏–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–∞–ø–∫–∏ (–∫–æ–º–∞–Ω–¥—ã –∏–ª–∏ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞)
          const findFolder = () => {
            const combined = (text + ' ' + file.name).toLowerCase();
            for (const [cmd, folderId] of Object.entries(COMMAND_MAP)) {
              if (combined.includes(cmd) || combined.includes(cmd.replace('/', ''))) return folderId;
            }
            if (combined.includes('—Å—á–µ—Ç') || combined.includes('inv')) return 'invoices';
            if (combined.includes('–Ω–∞–∫–ª') || combined.includes('—É–ø–¥')) return 'waybills';
            if (combined.includes('–¥–æ–≥')) return 'contracts';
            if (combined.includes('–Ω–∞–ª–æ–≥') || combined.includes('–æ—Ç—á–µ—Ç')) return 'taxes';
            return 'misc';
          };

          const targetFolder = findFolder();
          const docId = Math.random().toString(36).substr(2, 9);
          
          const newDoc = {
            id: docId,
            name: file.name,
            folder: targetFolder,
            date: new Date().toLocaleDateString('ru-RU'),
            size: (file.size / 1024).toFixed(1) + ' KB'
          };

          setDocuments(prev => [newDoc, ...prev]);
          setMessages(prev => [...prev, {
            id: Date.now().toString(),
            sender: 'user',
            text: text || `üìÑ –§–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω: ${file.name}`,
            attachedDocId: docId,
            timestamp: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
          }]);

          setIsUploading(false);
          setInputText('');
          showToastMsg('–î–æ–∫—É–º–µ–Ω—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω!');
        } else {
          setMessages(prev => [...prev, {
            id: Date.now().toString(),
            sender: 'user',
            text,
            timestamp: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
          }]);
          setInputText('');
        }
      };

      const showToastMsg = (msg) => {
        setShowToast(msg);
        setTimeout(() => setShowToast(null), 2000);
      };

      const copyLink = (id) => {
        const url = `${window.location.origin}${window.location.pathname}#doc=${id}`;
        navigator.clipboard.writeText(url);
        showToastMsg('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!');
      };

      return (
        <div className="flex flex-col h-screen max-w-lg mx-auto bg-white shadow-2xl relative overflow-hidden border-x border-gray-100">
          
          {/* Header */}
          <header className="px-4 py-3 border-b flex items-center justify-between bg-white z-20 shrink-0">
            <div className="flex items-center gap-2">
              <div className="w-8 h-8 rounded-lg bg-[#0088cc] flex items-center justify-center text-white text-lg font-bold">K</div>
              <h1 className="font-extrabold text-[14px] uppercase tracking-tighter text-gray-800">–ê—Ä—Ö–∏–≤ –ë—É—Ö–≥–∞–ª—Ç–µ—Ä–∏–∏</h1>
            </div>
            <div className="flex bg-gray-100 p-1 rounded-xl">
              <button onClick={() => setView('chat')} className={`px-4 py-1.5 text-[10px] font-bold rounded-lg transition-all ${view === 'chat' ? 'bg-white shadow-sm text-[#0088cc]' : 'text-gray-400'}`}>–ß–ê–¢</button>
              <button onClick={() => {setView('folders'); setCurrentFolder(null);}} className={`px-4 py-1.5 text-[10px] font-bold rounded-lg transition-all ${view === 'folders' ? 'bg-white shadow-sm text-[#0088cc]' : 'text-gray-400'}`}>–ü–ê–ü–ö–ò</button>
            </div>
          </header>

          <main className="flex-1 overflow-hidden relative">
            {view === 'chat' ? (
              <div className="flex flex-col h-full bg-[#f4f7f9]">
                <div className="flex-1 overflow-y-auto p-4 space-y-4">
                  {messages.map(m => (
                    <div key={m.id} className={`flex ${m.sender === 'user' ? 'justify-end' : 'justify-start'}`}>
                      <div className={`max-w-[85%] p-3 rounded-2xl shadow-sm text-[13px] leading-relaxed ${m.sender === 'user' ? 'chat-bubble-user' : 'chat-bubble-system'}`}>
                        <p className="whitespace-pre-wrap">{m.text}</p>
                        {m.attachedDocId && (
                          <div onClick={() => copyLink(m.attachedDocId)} className="mt-2 p-2.5 bg-black/5 rounded-xl flex items-center gap-3 cursor-pointer hover:bg-black/10 transition-colors">
                            <div className="w-8 h-8 rounded-lg bg-[#0088cc] text-white flex items-center justify-center shrink-0">üìÑ</div>
                            <div className="overflow-hidden">
                              <p className="text-[11px] font-bold truncate text-gray-700">{documents.find(d => d.id === m.attachedDocId)?.name}</p>
                              <p className="text-[9px] text-gray-400 font-bold uppercase tracking-tight">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É</p>
                            </div>
                          </div>
                        )}
                        <div className="text-[9px] text-gray-400 mt-1.5 text-right font-bold opacity-60 uppercase">{m.timestamp}</div>
                      </div>
                    </div>
                  ))}
                  {isUploading && (
                    <div className="flex justify-start">
                      <div className="bg-white p-3 rounded-2xl shadow-sm border border-gray-100 flex items-center gap-2">
                        <div className="loader !w-3 !h-3"></div>
                        <span className="text-[10px] font-bold text-gray-400 uppercase tracking-widest">–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...</span>
                      </div>
                    </div>
                  )}
                </div>

                {/* Input Area */}
                <div className="p-3 bg-white border-t flex items-center gap-2 shrink-0">
                  <input type="file" id="fileInput" className="hidden" onChange={e => {
                    const file = e.target.files[0];
                    if(file) handleSend(inputText, file);
                  }} />
                  <label htmlFor="fileInput" className="p-2 text-gray-400 cursor-pointer active:scale-90 transition-transform">
                    <svg className="w-6 h-6 rotate-45" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.414a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13" /></svg>
                  </label>
                  <input 
                    value={inputText} 
                    onChange={e => setInputText(e.target.value)} 
                    onKeyDown={e => e.key === 'Enter' && handleSend(inputText)}
                    placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ –∏–ª–∏ /–∫–æ–º–∞–Ω–¥–∞..." 
                    className="flex-1 bg-gray-50 border border-gray-100 rounded-2xl px-4 py-2 text-[13.5px] outline-none focus:ring-1 focus:ring-[#0088cc] transition-all"
                  />
                  <button 
                    onClick={() => handleSend(inputText)}
                    className="tg-button p-2.5 rounded-full shadow-lg active:scale-95 transition-transform"
                  >
                    <svg className="w-5 h-5 fill-current" viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z" /></svg>
                  </button>
                </div>
              </div>
            ) : (
              <div className="p-4 h-full overflow-y-auto bg-[#f4f7f9]">
                {!currentFolder ? (
                  <div className="grid grid-cols-1 gap-3">
                    <p className="text-[10px] font-black text-gray-400 uppercase tracking-widest mb-1 px-1">–í–∞—à –∞—Ä—Ö–∏–≤</p>
                    {FOLDERS.map(f => (
                      <div key={f.id} onClick={() => setCurrentFolder(f.id)} className="bg-white p-4 rounded-2xl flex items-center gap-4 shadow-sm active:scale-[0.98] transition-all border border-transparent hover:border-gray-200 cursor-pointer">
                        <div className={`${f.color} w-12 h-12 rounded-xl flex items-center justify-center text-xl shadow-md`}>{f.icon}</div>
                        <div className="flex-1">
                          <div className="font-bold text-[14px] text-gray-800">{f.name}</div>
                          <div className="text-[10px] text-gray-400 uppercase font-black tracking-tight">{documents.filter(d => d.folder === f.id).length} –æ–±—ä–µ–∫—Ç–æ–≤</div>
                        </div>
                        <svg className="w-4 h-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" /></svg>
                      </div>
                    ))}
                  </div>
                ) : (
                  <div className="bg-white rounded-3xl h-full flex flex-col shadow-xl border border-gray-100 overflow-hidden">
                    <div className="p-4 border-b flex justify-between items-center bg-gray-50/50">
                      <button onClick={() => setCurrentFolder(null)} className="text-[#0088cc] font-black text-[10px] uppercase flex items-center gap-1 tracking-widest">
                        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M15 19l-7-7 7-7" /></svg> –ù–∞–∑–∞–¥
                      </button>
                      <span className="text-[10px] font-black uppercase text-gray-400 tracking-widest">{FOLDERS.find(f => f.id === currentFolder).name}</span>
                    </div>
                    <div className="flex-1 overflow-y-auto divide-y divide-gray-50">
                      {documents.filter(d => d.folder === currentFolder).map(d => (
                        <div key={d.id} className="p-4 flex justify-between items-center group hover:bg-gray-50 transition-colors">
                          <div className="overflow-hidden pr-4 flex items-center gap-3">
                            <div className="w-8 h-8 rounded-lg bg-gray-100 flex items-center justify-center text-gray-400">üìÑ</div>
                            <div>
                              <div className="text-[13px] font-bold text-gray-700 truncate">{d.name}</div>
                              <div className="text-[10px] text-gray-400 font-medium">{d.date} ‚Ä¢ {d.size}</div>
                            </div>
                          </div>
                          <button 
                            onClick={() => copyLink(d.id)}
                            className="text-[#0088cc] text-[10px] font-black uppercase tracking-tighter shrink-0 p-2 hover:bg-blue-50 rounded-lg transition-colors"
                          >
                            –°—Å—ã–ª–∫–∞
                          </button>
                        </div>
                      ))}
                      {documents.filter(d => d.folder === currentFolder).length === 0 && (
                        <div className="p-12 text-center">
                          <div className="text-4xl mb-4 opacity-20">üìÇ</div>
                          <p className="text-[11px] font-black text-gray-300 uppercase tracking-widest">–ó–¥–µ—Å—å –ø–æ–∫–∞ –ø—É—Å—Ç–æ</p>
                        </div>
                      )}
                    </div>
                  </div>
                )}
              </div>
            )}
          </main>
          
          {/* Toast */}
          {showToast && (
            <div className="fixed bottom-20 left-1/2 -translate-x-1/2 bg-[#1f2937] text-white text-[10px] font-black px-6 py-2.5 rounded-2xl shadow-2xl z-[100] border border-white/10 uppercase tracking-widest animate-bounce">
              {showToast}
            </div>
          )}
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
